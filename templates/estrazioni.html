{% extends "base.html" %}

{% block title %}Salvataggio - Easyloading{% endblock %}

{% block extra_css %}
<style>
    .split-container {
        display: flex;
        height: calc(100vh - 140px);
        gap: 20px;
        margin-top: 20px;
    }
    
    .calendar-panel {
        flex: 0 0 50%;
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow-y: auto;
    }
    
    .details-panel {
        flex: 0 0 50%;
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow-y: auto;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .month-nav {
        background: #00457d;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s ease;
    }
    
    .month-nav:hover {
        background: #0056b3;
        transform: scale(1.1);
    }
    
    .current-month {
        font-size: 1.5rem;
        font-weight: 700;
        color: #00457d;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-top: 1rem;
    }
    
    .calendar-day-label {
        text-align: center;
        font-weight: 600;
        color: #6c757d;
        padding: 0.5rem;
        font-size: 0.9rem;
    }
    
    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        font-weight: 600;
        color: #495057;
    }
    
    .calendar-day:hover:not(.disabled):not(.selected) {
        background: #f0f0f0;
        border-color: #00457d;
    }
    
    .calendar-day.disabled {
        opacity: 0.3;
        cursor: not-allowed;
        background: #f8f9fa;
    }
    
    .calendar-day.has-extraction {
        background: #28a745;
        color: white;
        border-color: #20c997;
    }
    
    .calendar-day.selected {
        background: #00457d;
        color: white;
        border-color: #0056b3;
        transform: scale(1.1);
    }
    
    .details-empty {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .details-content {
        display: none;
    }
    
    .details-content.active {
        display: block;
    }
    
    .detail-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .detail-date {
        font-size: 1.5rem;
        font-weight: 700;
        color: #00457d;
        margin-bottom: 0.5rem;
    }
    
    .detail-info {
        color: #6c757d;
        font-size: 1rem;
    }
    
    .detail-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
    }
    
    .btn-action {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .btn-download {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        color: white;
    }
    
    .btn-view-json {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
    }
    
    .btn-view-json:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
        color: white;
    }
    
    .btn-view-details {
        background: linear-gradient(135deg, #00457d 0%, #0056b3 100%);
        color: white;
    }
    
    .btn-view-details:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 69, 125, 0.4);
        color: white;
    }
    
    @media (max-width: 992px) {
        .split-container {
            flex-direction: column;
            height: auto;
        }
        
        .calendar-panel,
        .details-panel {
            flex: 1 1 auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="section-title">
                <i class="bi bi-archive"></i>
                Salvataggi
            </h1>
        </div>
    </div>
    
    <div class="split-container">
        <!-- Calendario a sinistra -->
        <div class="calendar-panel">
            <div class="calendar-header">
                <button class="month-nav" id="prev-month">‹</button>
                <div class="current-month" id="current-month-year">Dicembre 2025</div>
                <button class="month-nav" id="next-month">›</button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        
        <!-- Dettagli a destra -->
        <div class="details-panel">
            <div id="details-empty" class="details-empty">
                <i class="bi bi-calendar-x" style="font-size: 4rem; color: #dee2e6;"></i>
                <h3 class="mt-3">Seleziona una data</h3>
                <p>Clicca su una data nel calendario per visualizzare i dettagli dell'estrazione</p>
            </div>
            
            <div id="details-content" class="details-content">
                <div class="detail-header">
                    <div class="detail-date" id="detail-date">
                        <i class="bi bi-calendar3 me-2"></i>
                        <span id="detail-date-text">--/--/----</span>
                    </div>
                    <div class="detail-info" id="detail-info">
                        <i class="bi bi-database me-1"></i>
                        <span id="detail-count">0 record</span>
                        <span id="detail-cache-badge" class="badge bg-info ms-2" style="display: none;">Cache</span>
                    </div>
                </div>
                
                <div class="detail-actions" id="detail-actions">
                    <!-- I pulsanti verranno aggiunti dinamicamente -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                       'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
    
    let currentDate = new Date();
    let selectedDate = null;
    let extractionsMap = new Map(); // Mappa: date -> extraction data
    let extractedDates = new Set(); // Set delle date con estrazioni
    
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthYear = document.getElementById('current-month-year');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const detailsEmpty = document.getElementById('details-empty');
    const detailsContent = document.getElementById('details-content');
    const detailDateText = document.getElementById('detail-date-text');
    const detailCount = document.getElementById('detail-count');
    const detailCacheBadge = document.getElementById('detail-cache-badge');
    const detailActions = document.getElementById('detail-actions');
    
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    function formatDateDisplay(dateStr) {
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
    }
    
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        currentMonthYear.textContent = `${monthNames[month]} ${year}`;
        calendarGrid.innerHTML = '';
        
        // Aggiungi le etichette dei giorni
        dayNames.forEach(day => {
            const label = document.createElement('div');
            label.className = 'calendar-day-label';
            label.textContent = day;
            calendarGrid.appendChild(label);
        });
        
        // Primo giorno del mese
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        // Aggiungi giorni vuoti all'inizio
        for (let i = 0; i < startingDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            calendarGrid.appendChild(emptyDay);
        }
        
        // Aggiungi i giorni del mese
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDate = new Date(year, month, day);
            const dateStr = formatDate(dayDate);
            const isToday = dayDate.getTime() === today.getTime();
            const hasExtraction = extractedDates.has(dateStr);
            const isSelected = selectedDate && formatDate(selectedDate) === dateStr;
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            
            if (hasExtraction) {
                dayElement.classList.add('has-extraction');
            }
            
            if (isSelected) {
                dayElement.classList.add('selected');
            }
            
            if (isToday) {
                dayElement.style.borderWidth = '3px';
            }
            
            // Non permettere selezione di date future
            if (dayDate > today) {
                dayElement.classList.add('disabled');
            } else {
                dayElement.addEventListener('click', () => {
                    selectedDate = dayDate;
                    renderCalendar();
                    showExtractionDetails(dateStr);
                });
            }
            
            calendarGrid.appendChild(dayElement);
        }
    }
    
    function showExtractionDetails(dateStr) {
        const extraction = extractionsMap.get(dateStr);
        
        if (extraction) {
            detailsEmpty.style.display = 'none';
            detailsContent.classList.add('active');
            
            detailDateText.textContent = formatDateDisplay(dateStr);
            detailCount.textContent = `${extraction.count || 0} record`;
            
            if (extraction.from_cache) {
                detailCacheBadge.style.display = 'inline-block';
            } else {
                detailCacheBadge.style.display = 'none';
            }
            
            // Costruisci i pulsanti
            const filename = extraction.filename || '';
            // Aggiungi parametro from_db=true per caricare da MongoDB (più veloce)
            const detailsUrl = `/risultati/${dateStr}?from_db=true`;
            
            detailActions.innerHTML = `
                <a href="/api/download_json/${filename}" class="btn-action btn-download">
                    <i class="bi bi-download"></i>
                    Scarica JSON
                </a>
                <a href="/api/view_json/${filename}" class="btn-action btn-view-json" target="_blank">
                    <i class="bi bi-file-earmark-code"></i>
                    Visualizza JSON
                </a>
                <a href="${detailsUrl}" class="btn-action btn-view-details" target="_blank">
                    <i class="bi bi-eye"></i>
                    Visualizza Dettagli
                </a>
            `;
        } else {
            detailsEmpty.style.display = 'block';
            detailsContent.classList.remove('active');
        }
    }
    
    async function loadExtractions() {
        try {
            const response = await fetch('/api/list_extractions');
            const data = await response.json();
            
            if (response.ok && data.extractions && data.extractions.length > 0) {
                extractionsMap.clear();
                extractedDates.clear();
                
                data.extractions.forEach(extraction => {
                    const date = extraction.date;
                    if (date && date !== 'N/A') {
                        extractionsMap.set(date, extraction);
                        extractedDates.add(date);
                    }
                });
                
                renderCalendar();
            }
        } catch (error) {
            console.error('Errore nel caricamento estrazioni:', error);
        }
    }
    
    // Navigazione mesi
    prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });
    
    nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });
    
    // Inizializza
    renderCalendar();
    loadExtractions();
</script>
{% endblock %}
